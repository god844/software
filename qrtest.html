<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Uniform Management System - Enhanced QR</title>
    
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --secondary: #7c3aed;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --dark: #111827;
            --gray: #6b7280;
            --light: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: var(--white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-xl);
            background-image: linear-gradient(135deg, var(--white) 0%, #f0f9ff 100%);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%);
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(50px, -50px);
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            font-weight: 400;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--white);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
        }

        .tab-btn {
            padding: 14px 28px;
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .tab-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Styles */
        .dashboard-card {
            background: var(--white);
            border-radius: 20px;
            padding: 35px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        /* Uniform Selection Styles */
        .uniform-category {
            margin-bottom: 35px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--border);
        }

        .category-header h3 {
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .uniform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }

        .uniform-item {
            padding: 15px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--white);
            position: relative;
            overflow: hidden;
        }

        .uniform-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .uniform-item.selected {
            background: linear-gradient(135deg, #dbeafe 0%, #e9d5ff 100%);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .uniform-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 35px;
            padding: 25px;
            background: var(--light);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .form-section h4 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #6d28d9);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #047857);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* Magic Card Styles */
        .magic-card-container {
            max-width: 800px;
            margin: 0 auto 30px;
        }

        .magic-card {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .magic-card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 30px;
            text-align: center;
        }

        .magic-card-body {
            padding: 30px;
        }

        .magic-card-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .magic-card-section:last-child {
            border-bottom: none;
        }

        .magic-card-field {
            display: flex;
            margin-bottom: 10px;
        }

        .magic-card-field-label {
            font-weight: 600;
            color: var(--dark);
            min-width: 150px;
        }

        .magic-card-field-value {
            color: var(--gray);
            flex: 1;
        }

        /* Enhanced QR Code Section */
        .magic-card-qr {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background: var(--light);
        }

        .qr-wrapper {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        /* QR Scanner Styles */
        .scanner-container {
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            background: #000;
            min-height: 300px;
            display: none;
        }

        .scanner-container.active {
            display: block;
        }

        #reader {
            width: 100%;
            position: relative;
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff88, transparent);
            animation: scan 2s linear infinite;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(59, 130, 246, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-dark);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(5, 150, 105, 0.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--white);
            padding: 18px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            display: none;
            z-index: 9999;
            min-width: 300px;
            border-left: 4px solid var(--success);
        }

        .notification.show {
            display: block;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 1.8rem; }
            .uniform-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }

        @media print {
            body { background: white; }
            .tabs, .btn, .notification { display: none !important; }
            .magic-card { box-shadow: none; border: 1px solid #000; }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification">
        <div>Operation completed</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üëî School Uniform Management System</h1>
            <p class="subtitle">Professional Uniform Selection with Enhanced QR Tracking</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('selection', this)">üìã Uniform Selection</button>
            <button class="tab-btn" onclick="switchTab('itemManager', this)">üéØ Item Manager</button>
            <button class="tab-btn" onclick="switchTab('magicCards', this)">üé¥ Magic Cards</button>
            <button class="tab-btn" onclick="switchTab('qrScanner', this)">üì± QR Scanner</button>
            <button class="tab-btn" onclick="switchTab('dashboard', this)">üìä Dashboard</button>
        </div>

        <!-- Uniform Selection Tab -->
        <div id="selection" class="tab-content active">
            <div class="dashboard-card">
                <h2>üìã Select Uniforms for Your Institution</h2>
                <p style="color: var(--gray); margin-bottom: 25px;">Choose items to include in your uniform catalog.</p>

                <!-- Boys Section -->
                <div class="uniform-category">
                    <div class="category-header">
                        <span style="font-size: 1.8rem;">üë¶</span>
                        <h3>Boys Uniforms</h3>
                    </div>
                    
                    <h4 style="color: var(--gray); margin-bottom: 15px;">Formals</h4>
                    <div class="uniform-grid" id="boysFormalGrid"></div>

                    <h4 style="color: var(--gray); margin: 25px 0 15px;">Sports Wear</h4>
                    <div class="uniform-grid" id="boysSportsGrid"></div>

                    <h4 style="color: var(--gray); margin: 25px 0 15px;">Accessories</h4>
                    <div class="uniform-grid" id="boysAccessoriesGrid"></div>
                </div>

                <!-- Girls Section -->
                <div class="uniform-category">
                    <div class="category-header">
                        <span style="font-size: 1.8rem;">üëß</span>
                        <h3>Girls Uniforms</h3>
                    </div>
                    
                    <h4 style="color: var(--gray); margin-bottom: 15px;">Formals</h4>
                    <div class="uniform-grid" id="girlsFormalGrid"></div>

                    <h4 style="color: var(--gray); margin: 25px 0 15px;">Sports Wear</h4>
                    <div class="uniform-grid" id="girlsSportsGrid"></div>

                    <h4 style="color: var(--gray); margin: 25px 0 15px;">Accessories</h4>
                    <div class="uniform-grid" id="girlsAccessoriesGrid"></div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="system.saveSelection()">üíæ Save Selection</button>
                    <button class="btn btn-secondary" onclick="system.clearSelection()">üîÑ Clear All</button>
                </div>
            </div>
        </div>

        <!-- Item Manager Tab -->
        <div id="itemManager" class="tab-content">
            <div class="dashboard-card">
                <h2>üéØ Manage Selected Items</h2>
                <p style="color: var(--gray); margin-bottom: 25px;">Configure each selected uniform item.</p>
                <div id="selectedItemsList"></div>
            </div>
        </div>

        <!-- Magic Cards Tab -->
        <div id="magicCards" class="tab-content">
            <div class="dashboard-card">
                <h2>üé¥ Magic Cards Gallery</h2>
                <p style="color: var(--gray); margin-bottom: 25px;">View and download magic cards with QR codes.</p>
                <div id="magicCardsGallery"></div>
            </div>
        </div>

        <!-- QR Scanner Tab -->
        <div id="qrScanner" class="tab-content">
            <div class="dashboard-card">
                <h2>üì± Enhanced QR Scanner</h2>
                <p style="color: var(--gray); margin-bottom: 25px;">Scan QR codes from magic cards.</p>

                <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                    <div class="scanner-container" id="scanner-container">
                        <div id="reader">
                            <div class="scan-line"></div>
                        </div>
                    </div>

                    <div class="btn-group" style="justify-content: center;">
                        <button class="btn" id="startScanBtn" onclick="system.startScanner()">üì∑ Start Scanner</button>
                        <button class="btn btn-danger" id="stopScanBtn" onclick="system.stopScanner()" style="display: none;">‚èπÔ∏è Stop Scanner</button>
                    </div>

                    <div class="upload-area" onclick="document.getElementById('qr-file-input').click()">
                        <div style="font-size: 48px; color: var(--primary); margin-bottom: 15px;">üì∑</div>
                        <p style="color: var(--primary); font-weight: 600;">Click to upload QR image or drag & drop</p>
                        <input type="file" id="qr-file-input" accept="image/*" style="display: none;" onchange="system.handleFile(event)">
                    </div>

                    <div id="scanResult" style="display: none; margin-top: 30px;"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-card">
                <h2>üìä Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItemsStat">0</div>
                        <div>Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="configuredItemsStat">0</div>
                        <div>Configured</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="magicCardsStat">0</div>
                        <div>Magic Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="qrScansStat">0</div>
                        <div>QR Scanned</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Uniform Management System
        class UniformManagementSystem {
            constructor() {
                this.data = {
                    selectedItems: [],
                    itemConfigurations: {},
                    magicCards: {},
                    scanHistory: []
                };
                this.currentScanner = null;
                this.loadData();
                this.init();
            }

            init() {
                this.populateUniformItems();
                this.updateDashboard();
                this.setupDragDrop();
            }

            populateUniformItems() {
                const uniformData = {
                    boys: {
                        formals: ['Half-sleeve formal shirt', 'Full-sleeve formal shirt', 'Shorts', 'Elastic shorts', 
                                 'Formal trousers', 'Elastic waist trousers', 'Waistcoat', 'Blazer', 'Sweater', 'Cardigan'],
                        sports: ['House T-shirt Green', 'House T-shirt Blue', 'House T-shirt Red', 'House T-shirt Yellow',
                                'Track pants', 'Track shorts', 'Jerkin', 'Sports jacket', 'Pullover with hood', 'House jersey'],
                        accessories: ['Tie', 'Cap', 'Socks', 'Belt', 'Black school shoes', 'Sports shoes']
                    },
                    girls: {
                        formals: ['Half-sleeve formal shirt', 'Full-sleeve formal shirt', 'Pinafore for juniors', 'Skirt', 
                                 'Skorts', 'Special frock KG', 'Special Frock primary', 'Kurta top', 'Kurta pants',
                                 'Formal trousers', 'Elastic waist trousers', 'Waistcoat', 'Blazer', 'Bloomers', 
                                 'Under skirts', 'Formal T-shirt', 'Sweater / cardigan'],
                        sports: ['House T-shirt Green', 'House T-shirt Blue', 'House T-shirt Red', 'House T-shirt Yellow',
                                'Track pants', 'Track shorts', 'Jerkin', 'Sports jacket', 'Pullover with hood', 'House jersey'],
                        accessories: ['Tie', 'Cap', 'Socks', 'Belt', 'Hair accessories', 'Black school shoes lace',
                                     'Black school shoes buckle', 'Sports shoes']
                    }
                };

                this.populateGrid('boysFormalGrid', uniformData.boys.formals, 'boys-formal');
                this.populateGrid('boysSportsGrid', uniformData.boys.sports, 'boys-sports');
                this.populateGrid('boysAccessoriesGrid', uniformData.boys.accessories, 'boys-accessories');
                this.populateGrid('girlsFormalGrid', uniformData.girls.formals, 'girls-formal');
                this.populateGrid('girlsSportsGrid', uniformData.girls.sports, 'girls-sports');
                this.populateGrid('girlsAccessoriesGrid', uniformData.girls.accessories, 'girls-accessories');

                this.restoreSelections();
            }

            populateGrid(gridId, items, category) {
                const grid = document.getElementById(gridId);
                if (!grid) return;

                grid.innerHTML = '';
                items.forEach(item => {
                    const itemId = `${category}-${item.replace(/\s+/g, '-').toLowerCase()}`;
                    const itemElement = document.createElement('div');
                    itemElement.className = 'uniform-item';
                    itemElement.dataset.itemId = itemId;
                    itemElement.dataset.itemName = item;
                    itemElement.dataset.category = category;
                    itemElement.onclick = (e) => this.toggleItem(itemElement, e);

                    itemElement.innerHTML = `
                        <input type="checkbox" id="${itemId}">
                        <span>${item}</span>
                    `;
                    grid.appendChild(itemElement);
                });
            }

            toggleItem(element, event) {
                const checkbox = element.querySelector('input[type="checkbox"]');
                if (event.target.type !== 'checkbox') {
                    checkbox.checked = !checkbox.checked;
                }
                element.classList.toggle('selected', checkbox.checked);
                this.updateSelectedItems();
            }

            updateSelectedItems() {
                const selectedItems = [];
                document.querySelectorAll('.uniform-item.selected').forEach(item => {
                    selectedItems.push({
                        id: item.dataset.itemId,
                        name: item.dataset.itemName,
                        category: item.dataset.category
                    });
                });
                this.data.selectedItems = selectedItems;
            }

            restoreSelections() {
                this.data.selectedItems.forEach(item => {
                    const element = document.querySelector(`[data-item-id="${item.id}"]`);
                    if (element) {
                        element.classList.add('selected');
                        element.querySelector('input[type="checkbox"]').checked = true;
                    }
                });
            }

            saveSelection() {
                this.updateSelectedItems();
                this.saveData();
                this.displaySelectedItems();
                this.updateDashboard();
                this.showNotification('Selection saved successfully!');
                switchTab('itemManager', document.querySelector('.tab-btn[onclick*="itemManager"]'));
            }

            clearSelection() {
                if (confirm('Clear all selections?')) {
                    document.querySelectorAll('.uniform-item').forEach(item => {
                        item.classList.remove('selected');
                        item.querySelector('input[type="checkbox"]').checked = false;
                    });
                    this.data.selectedItems = [];
                    this.saveData();
                    this.updateDashboard();
                }
            }

            displaySelectedItems() {
                const container = document.getElementById('selectedItemsList');
                if (!container) return;

                if (this.data.selectedItems.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray);">No items selected.</p>';
                    return;
                }

                container.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">' +
                    this.data.selectedItems.map(item => {
                        const config = this.data.itemConfigurations[item.id];
                        const hasConfig = config && Object.keys(config).length > 0;
                        return `
                            <div style="background: var(--white); border-radius: 12px; padding: 20px; box-shadow: var(--shadow-md);">
                                <h3 style="color: var(--primary); margin-bottom: 15px;">${item.name}</h3>
                                <p style="color: var(--gray); margin-bottom: 15px;">
                                    ${hasConfig ? '‚úÖ Configured' : '‚ö†Ô∏è Pending Configuration'}
                                </p>
                                <button class="btn btn-secondary" onclick="system.openConfigForm('${item.id}', '${item.name}')">
                                    ${hasConfig ? 'Edit' : 'Configure'}
                                </button>
                                ${hasConfig ? `<button class="btn" onclick="system.viewMagicCard('${item.id}')" style="margin-left: 10px;">View Card</button>` : ''}
                            </div>
                        `;
                    }).join('') + '</div>';
            }

            openConfigForm(itemId, itemName) {
                const config = this.data.itemConfigurations[itemId] || {};
                
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h2>Configure: ${itemName}</h2>
                        <form id="configForm">
                            <div class="form-section">
                                <h4>Institution Details</h4>
                                <div class="form-group">
                                    <label>Institution Name</label>
                                    <input type="text" name="institution" value="${config.institution || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Contact Person</label>
                                    <input type="text" name="contact" value="${config.contact || ''}" required>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4>Specifications</h4>
                                <div class="form-group">
                                    <label>Fabric Type</label>
                                    <input type="text" name="fabric" value="${config.fabric || ''}" placeholder="e.g., Cotton">
                                </div>
                                <div class="form-group">
                                    <label>Color</label>
                                    <input type="text" name="color" value="${config.color || ''}" placeholder="e.g., Blue">
                                </div>
                                <div class="form-group">
                                    <label>Boys Sizes</label>
                                    <input type="text" name="boysSizes" value="${config.boysSizes || ''}" placeholder="e.g., 20-42">
                                </div>
                                <div class="form-group">
                                    <label>Girls Sizes</label>
                                    <input type="text" name="girlsSizes" value="${config.girlsSizes || ''}" placeholder="e.g., 20-40">
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success">Save</button>
                                <button type="button" class="btn btn-danger" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('#configForm').onsubmit = (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const newConfig = {};
                    formData.forEach((value, key) => newConfig[key] = value);
                    newConfig.itemName = itemName;
                    newConfig.itemId = itemId;
                    
                    this.data.itemConfigurations[itemId] = newConfig;
                    this.generateMagicCard(itemId);
                    this.saveData();
                    modal.remove();
                    this.displaySelectedItems();
                    this.updateDashboard();
                    this.showNotification('Configuration saved!');
                };
            }

            generateMagicCard(itemId) {
                const config = this.data.itemConfigurations[itemId];
                if (!config) return;

                // Create comprehensive QR data
                const qrData = {
                    version: '2.0',
                    type: 'MAGIC_CARD',
                    id: itemId,
                    timestamp: Date.now(),
                    institution: config.institution,
                    contact: config.contact,
                    item: config.itemName,
                    fabric: config.fabric,
                    color: config.color,
                    sizes: {
                        boys: config.boysSizes,
                        girls: config.girlsSizes
                    }
                };

                this.data.magicCards[itemId] = {
                    ...config,
                    qrData: JSON.stringify(qrData),
                    generatedDate: new Date().toISOString()
                };
                this.saveData();
            }

            viewMagicCard(itemId) {
                this.displayMagicCards([itemId]);
                switchTab('magicCards', document.querySelector('.tab-btn[onclick*="magicCards"]'));
            }

            displayMagicCards(itemIds = null) {
                const container = document.getElementById('magicCardsGallery');
                const cardsToDisplay = itemIds || Object.keys(this.data.magicCards);

                if (cardsToDisplay.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray);">No magic cards generated yet.</p>';
                    return;
                }

                container.innerHTML = cardsToDisplay.map(itemId => {
                    const card = this.data.magicCards[itemId];
                    if (!card) return '';
                    
                    return `
                        <div class="magic-card-container">
                            <div class="magic-card" id="card-${itemId}">
                                <div class="magic-card-header">
                                    <h2>${card.institution || 'Institution'}</h2>
                                    <h3>MAGIC CARD - ${card.itemName}</h3>
                                </div>
                                
                                <div class="magic-card-body">
                                    <div class="magic-card-section">
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Item:</span>
                                            <span class="magic-card-field-value">${card.itemName}</span>
                                        </div>
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Contact:</span>
                                            <span class="magic-card-field-value">${card.contact || 'N/A'}</span>
                                        </div>
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Fabric:</span>
                                            <span class="magic-card-field-value">${card.fabric || 'N/A'}</span>
                                        </div>
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Color:</span>
                                            <span class="magic-card-field-value">${card.color || 'N/A'}</span>
                                        </div>
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Boys Sizes:</span>
                                            <span class="magic-card-field-value">${card.boysSizes || 'N/A'}</span>
                                        </div>
                                        <div class="magic-card-field">
                                            <span class="magic-card-field-label">Girls Sizes:</span>
                                            <span class="magic-card-field-value">${card.girlsSizes || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="magic-card-qr">
                                    <div class="qr-wrapper">
                                        <div id="qr-${itemId}"></div>
                                    </div>
                                    <p style="margin-top: 15px; color: var(--gray);">Scan for complete specifications</p>
                                </div>
                            </div>
                            
                            <div class="btn-group" style="justify-content: center;">
                                <button class="btn" onclick="window.print()">Print</button>
                                <button class="btn btn-secondary" onclick="system.testQR('${itemId}')">Test QR</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Generate QR codes
                cardsToDisplay.forEach(itemId => {
                    const card = this.data.magicCards[itemId];
                    if (card && card.qrData) {
                        setTimeout(() => {
                            const element = document.getElementById(`qr-${itemId}`);
                            if (element && element.innerHTML === '') {
                                new QRCode(element, {
                                    text: card.qrData,
                                    width: 200,
                                    height: 200,
                                    colorDark: "#1e40af",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            }
                        }, 100);
                    }
                });
            }

            testQR(itemId) {
                const card = this.data.magicCards[itemId];
                if (card && card.qrData) {
                    this.handleQRData(card.qrData);
                }
            }

            // QR Scanner Functions
            setupDragDrop() {
                const uploadArea = document.querySelector('.upload-area');
                if (!uploadArea) return;

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.scanFile(file);
                    }
                });
            }

            async startScanner() {
                const container = document.getElementById('scanner-container');
                const startBtn = document.getElementById('startScanBtn');
                const stopBtn = document.getElementById('stopScanBtn');

                container.classList.add('active');
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';

                try {
                    const html5QrCode = new Html5Qrcode("reader");
                    await html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            this.handleQRData(decodedText);
                            this.stopScanner();
                        }
                    );
                    this.currentScanner = html5QrCode;
                } catch (err) {
                    console.error('Scanner error:', err);
                    this.showNotification('Camera not available. Please upload image.');
                    this.stopScanner();
                }
            }

            stopScanner() {
                if (this.currentScanner) {
                    this.currentScanner.stop();
                    this.currentScanner = null;
                }
                
                const container = document.getElementById('scanner-container');
                const startBtn = document.getElementById('startScanBtn');
                const stopBtn = document.getElementById('stopScanBtn');
                
                container.classList.remove('active');
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
            }

            handleFile(event) {
                const file = event.target.files[0];
                if (file) this.scanFile(file);
            }

            async scanFile(file) {
                try {
                    const html5QrCode = new Html5Qrcode("temp-reader");
                    const result = await html5QrCode.scanFile(file, true);
                    this.handleQRData(result);
                } catch (err) {
                    console.error('File scan error:', err);
                    this.showNotification('Could not read QR code from image');
                }
            }

            handleQRData(data) {
                try {
                    const qrData = JSON.parse(data);
                    this.displayScanResult(qrData);
                    this.data.scanHistory.push({ data: qrData, timestamp: new Date().toISOString() });
                    this.saveData();
                    this.updateDashboard();
                } catch (err) {
                    console.error('QR parse error:', err);
                    this.showNotification('Invalid QR code data');
                }
            }

            displayScanResult(data) {
                const resultDiv = document.getElementById('scanResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="magic-card">
                        <div class="magic-card-header">
                            <h2>${data.institution || 'Scanned Result'}</h2>
                        </div>
                        <div class="magic-card-body">
                            <div class="magic-card-section">
                                <div class="magic-card-field">
                                    <span class="magic-card-field-label">Item:</span>
                                    <span class="magic-card-field-value">${data.item || 'N/A'}</span>
                                </div>
                                <div class="magic-card-field">
                                    <span class="magic-card-field-label">Contact:</span>
                                    <span class="magic-card-field-value">${data.contact || 'N/A'}</span>
                                </div>
                                <div class="magic-card-field">
                                    <span class="magic-card-field-label">Fabric:</span>
                                    <span class="magic-card-field-value">${data.fabric || 'N/A'}</span>
                                </div>
                                <div class="magic-card-field">
                                    <span class="magic-card-field-label">Color:</span>
                                    <span class="magic-card-field-value">${data.color || 'N/A'}</span>
                                </div>
                                ${data.sizes ? `
                                    <div class="magic-card-field">
                                        <span class="magic-card-field-label">Boys Sizes:</span>
                                        <span class="magic-card-field-value">${data.sizes.boys || 'N/A'}</span>
                                    </div>
                                    <div class="magic-card-field">
                                        <span class="magic-card-field-label">Girls Sizes:</span>
                                        <span class="magic-card-field-value">${data.sizes.girls || 'N/A'}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            updateDashboard() {
                document.getElementById('totalItemsStat').textContent = this.data.selectedItems.length;
                document.getElementById('configuredItemsStat').textContent = Object.keys(this.data.itemConfigurations).length;
                document.getElementById('magicCardsStat').textContent = Object.keys(this.data.magicCards).length;
                document.getElementById('qrScansStat').textContent = this.data.scanHistory.length;
            }

            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            saveData() {
                localStorage.setItem('uniformSystemEnhanced', JSON.stringify(this.data));
            }

            loadData() {
                const saved = localStorage.getItem('uniformSystemEnhanced');
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            }
        }

        // Initialize System
        const system = new UniformManagementSystem();

        // Tab Switching
        function switchTab(tabName, button) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            if (button) button.classList.add('active');
            
            if (tabName === 'itemManager') system.displaySelectedItems();
            else if (tabName === 'magicCards') system.displayMagicCards();
            else if (tabName === 'dashboard') system.updateDashboard();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            system.updateDashboard();
            system.displaySelectedItems();
            system.displayMagicCards();
        });
    </script>
</body>
</html>
