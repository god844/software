<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dress Data Entry - Tailor Dashboard</title>
    <style>
        :root {
            --primary-color: #495057;
            --secondary-color: #6C757D;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #F8F9FA;
            --white-bg: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        [data-theme="dark"] {
            --light-bg: #1a1a1a;
            --white-bg: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --primary-color: #6c757d;
            --secondary-color: #8a9ba8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-content h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header-content p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--white-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .garment-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .garment-card {
            background: var(--light-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .garment-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .garment-card.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .garment-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .garment-card p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .measurement-input {
            position: relative;
        }

        .measurement-input.autofilled {
            background: linear-gradient(45deg, #fff3cd 0%, #ffffff 50%);
        }

        [data-theme="dark"] .measurement-input.autofilled {
            background: linear-gradient(45deg, #3d3d00 0%, #2d2d2d 50%);
        }

        .autofill-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--warning-color);
            color: var(--text-primary);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        [data-theme="dark"] .disclaimer {
            background: linear-gradient(135deg, #3d3d00 0%, #4a4a00 100%);
            border-color: #666600;
        }

        .disclaimer-icon {
            color: var(--warning-color);
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .disclaimer-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .disclaimer-text strong {
            color: var(--text-primary);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .garment-selector {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .measurements-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .form-group input, .form-group select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>🧵 Student Dress Data Entry</h1>
                <p>Premium Tailor Auto-Fill System with BPC Matching</p>
            </div>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    🌙 Dark Mode
                </button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Student Profile Section -->
            <div class="card">
                <h2 class="card-title">👤 Student Profile</h2>
                
                <div class="form-group">
                    <label for="studentId">Student ID Number</label>
                    <input type="text" id="studentId" placeholder="Enter student ID number">
                </div>

                <div class="form-group">
                    <label for="schoolRegNumber">School Register Number</label>
                    <input type="text" id="schoolRegNumber" placeholder="Enter school register number">
                </div>

                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter full name">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="class">Class</label>
                        <input type="text" id="class" placeholder="Enter class (e.g., 8, 10, 12)">
                    </div>
                    <div class="form-group">
                        <label for="division">Division</label>
                        <input type="text" id="division" placeholder="Enter division (e.g., A, B, C)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <div style="position: relative;">
                            <input type="date" id="dob" onchange="calculateAge()" 
                                   max="2020-12-31" min="1990-01-01"
                                   style="font-size: 1rem; cursor: pointer;">
                            <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;">
                                📅
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sex">Gender</label>
                        <select id="sex" onchange="updateGarmentOptions()">
                            <option value="">Select Gender</option>
                            <option value="M">👦 Male</option>
                            <option value="F">👧 Female</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="height">Height (cm)</label>
                        <input type="number" id="height" placeholder="e.g., 165" step="0.1" onchange="calculateMetrics()">
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="e.g., 55.5" step="0.1" onchange="calculateMetrics()">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="age">Age (Auto-calculated)</label>
                        <input type="number" id="age" readonly style="background: var(--light-bg);">
                    </div>
                    <div class="form-group">
                        <label for="bmi">BMI (Auto-calculated)</label>
                        <input type="number" id="bmi" readonly style="background: var(--light-bg);" step="0.01">
                    </div>
                </div>

                <button class="btn btn-success" onclick="findMatch()" id="findMatchBtn">
                    🔍 Find BPC Match & Auto-Fill
                </button>

                <div id="matchResult" class="hidden" style="margin-top: 15px;">
                    <div class="alert alert-success">
                        <span>✅</span>
                        <span id="matchText"></span>
                    </div>
                </div>
            </div>

            <!-- Measurements Section -->
            <div class="card">
                <h2 class="card-title">📏 Measurements Entry</h2>

                <!-- Garment Type Selection -->
                <div class="form-group">
                    <label>Select Garment Type</label>
                    <div class="garment-selector" id="garmentSelector">
                        <!-- Will be populated based on gender -->
                    </div>
                </div>

                <!-- Auto-fill Disclaimer -->
                <div id="autoFillDisclaimer" class="disclaimer hidden">
                    <div class="disclaimer-icon">⚠️</div>
                    <div class="disclaimer-text">
                        <strong>Auto-Fill Notice:</strong> The measurements below have been automatically filled based on Body Proportion Composite (BPC) matching with similar students. 
                        <strong>These values are predictions and may not be 100% accurate.</strong> 
                        Please review and manually adjust all measurements as needed for the best fit.
                    </div>
                </div>

                <!-- Measurements Grid -->
                <div id="measurementsContainer" class="hidden">
                    <div class="measurements-grid" id="measurementsGrid">
                        <!-- Will be populated based on selected garment -->
                    </div>

                    <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="saveMeasurements()">
                            💾 Save Measurements
                        </button>
                        <button class="btn btn-warning" onclick="clearMeasurements()">
                            🔄 Clear All
                        </button>
                        <button class="btn" onclick="newStudent()">
                            ➕ Add Another Student
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="card" style="margin-top: 20px;">
            <h2 class="card-title">🚀 Quick Actions</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button class="btn" onclick="newStudent()" style="padding: 15px;">
                    ➕ Add New Student
                </button>
                <button class="btn" onclick="searchStudent()" style="padding: 15px;">
                    🔍 Search Student
                </button>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>
    </div>

    <script>
        // Global variables
        let selectedGarment = '';
        let autoFilledData = {};
        let currentTheme = 'light';
        const API_KEY = 'tailor_mgmt_sk_7f2d9e4a8c1b6h3j5k9m2p7q4r8s6t1x3z'; // Your secure API key

        // API request helper with authentication
        async function apiRequest(action, data = {}) {
            try {
                const response = await fetch('student_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }
        const garmentTypes = {
            M: [
                { id: 'formal_shirt_boys', name: 'Formal Shirt', desc: 'School uniform shirt' },
                { id: 'formal_trousers', name: 'Formal Trousers', desc: 'School uniform pants' },
                { id: 'blazer', name: 'Blazer', desc: 'Winter uniform' },
                { id: 'pe_tshirt', name: 'PE T-Shirt', desc: 'Sports uniform' },
                { id: 'pe_shorts', name: 'PE Shorts', desc: 'Sports shorts' },
                { id: 'track_pants', name: 'Track Pants', desc: 'Sports pants' }
            ],
            F: [
                { id: 'formal_shirt_girls', name: 'Formal Shirt', desc: 'School uniform shirt' },
                { id: 'formal_skirt', name: 'Formal Skirt', desc: 'School uniform skirt' },
                { id: 'tunic', name: 'Tunic', desc: 'School tunic' },
                { id: 'pinafore', name: 'Pinafore', desc: 'School pinafore' },
                { id: 'blazer', name: 'Blazer', desc: 'Winter uniform' },
                { id: 'pe_tshirt', name: 'PE T-Shirt', desc: 'Sports uniform' },
                { id: 'kurta_salwar', name: 'Kurta & Salwar', desc: 'Traditional uniform' }
            ]
        };

        // Measurement fields for each garment type
        const measurementFields = {
            formal_shirt_boys: [
                { id: 'chest', label: 'Chest (cm)', placeholder: '85' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '75' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '42' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '58' },
                { id: 'shirt_length', label: 'Shirt Length (cm)', placeholder: '70' },
                { id: 'collar', label: 'Collar (cm)', placeholder: '38' }
            ],
            formal_shirt_girls: [
                { id: 'bust', label: 'Bust (cm)', placeholder: '80' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '70' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '38' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '55' },
                { id: 'shirt_length', label: 'Shirt Length (cm)', placeholder: '65' },
                { id: 'collar', label: 'Collar (cm)', placeholder: '35' }
            ],
            formal_trousers: [
                { id: 'waist', label: 'Waist (cm)', placeholder: '75' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '90' },
                { id: 'thigh', label: 'Thigh (cm)', placeholder: '55' },
                { id: 'inseam', label: 'Inseam (cm)', placeholder: '75' },
                { id: 'outseam', label: 'Outseam (cm)', placeholder: '100' },
                { id: 'bottom', label: 'Bottom (cm)', placeholder: '35' }
            ],
            formal_skirt: [
                { id: 'waist', label: 'Waist (cm)', placeholder: '70' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '85' },
                { id: 'length', label: 'Length (cm)', placeholder: '45' },
                { id: 'bottom_width', label: 'Bottom Width (cm)', placeholder: '120' }
            ],
            tunic: [
                { id: 'bust', label: 'Bust (cm)', placeholder: '80' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '70' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '85' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '38' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '50' },
                { id: 'tunic_length', label: 'Tunic Length (cm)', placeholder: '85' }
            ],
            pinafore: [
                { id: 'bust', label: 'Bust (cm)', placeholder: '78' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '68' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '83' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '36' },
                { id: 'armhole', label: 'Armhole (cm)', placeholder: '40' },
                { id: 'length', label: 'Length (cm)', placeholder: '90' }
            ],
            blazer: [
                { id: 'chest', label: 'Chest (cm)', placeholder: '88' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '78' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '44' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '60' },
                { id: 'blazer_length', label: 'Blazer Length (cm)', placeholder: '65' },
                { id: 'lapel_width', label: 'Lapel Width (cm)', placeholder: '8' }
            ],
            pe_tshirt: [
                { id: 'chest', label: 'Chest (cm)', placeholder: '85' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '75' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '42' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '25' },
                { id: 'tshirt_length', label: 'T-Shirt Length (cm)', placeholder: '65' }
            ],
            pe_shorts: [
                { id: 'waist', label: 'Waist (cm)', placeholder: '70' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '85' },
                { id: 'thigh', label: 'Thigh (cm)', placeholder: '50' },
                { id: 'length', label: 'Length (cm)', placeholder: '35' },
                { id: 'bottom', label: 'Bottom (cm)', placeholder: '50' }
            ],
            track_pants: [
                { id: 'waist', label: 'Waist (cm)', placeholder: '75' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '90' },
                { id: 'thigh', label: 'Thigh (cm)', placeholder: '55' },
                { id: 'inseam', label: 'Inseam (cm)', placeholder: '75' },
                { id: 'outseam', label: 'Outseam (cm)', placeholder: '100' },
                { id: 'bottom', label: 'Bottom (cm)', placeholder: '25' }
            ],
            kurta_salwar: [
                { id: 'bust', label: 'Bust (cm)', placeholder: '80' },
                { id: 'waist', label: 'Waist (cm)', placeholder: '70' },
                { id: 'hip', label: 'Hip (cm)', placeholder: '85' },
                { id: 'shoulder', label: 'Shoulder (cm)', placeholder: '38' },
                { id: 'sleeve_length', label: 'Sleeve Length (cm)', placeholder: '55' },
                { id: 'kurta_length', label: 'Kurta Length (cm)', placeholder: '95' },
                { id: 'salwar_waist', label: 'Salwar Waist (cm)', placeholder: '68' },
                { id: 'salwar_length', label: 'Salwar Length (cm)', placeholder: '90' }
            ]
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set max date to today for better UX
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dob').max = today;
            
            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                toggleTheme();
            }
        });

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (currentTheme === 'light') {
                body.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '☀️ Light Mode';
                currentTheme = 'dark';
            } else {
                body.removeAttribute('data-theme');
                themeToggle.innerHTML = '🌙 Dark Mode';
                currentTheme = 'light';
            }
            
            localStorage.setItem('theme', currentTheme);
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            alertContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type}">
                    <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) alert.remove();
            }, 5000);
        }

        // Calculate age from DOB
        function calculateAge() {
            const dob = document.getElementById('dob').value;
            if (dob) {
                const today = new Date();
                const birthDate = new Date(dob);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                document.getElementById('age').value = age;
                calculateMetrics();
            }
        }

        // Calculate BMI and other metrics
        function calculateMetrics() {
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            
            if (height && weight) {
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                document.getElementById('bmi').value = bmi.toFixed(2);
            }
        }

        // Update garment options based on gender
        function updateGarmentOptions() {
            const sex = document.getElementById('sex').value;
            const garmentSelector = document.getElementById('garmentSelector');
            
            if (sex && garmentTypes[sex]) {
                garmentSelector.innerHTML = '';
                garmentTypes[sex].forEach(garment => {
                    garmentSelector.innerHTML += `
                        <div class="garment-card" onclick="selectGarment('${garment.id}')">
                            <h4>${garment.name}</h4>
                            <p>${garment.desc}</p>
                        </div>
                    `;
                });
            } else {
                garmentSelector.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Please select gender first</p>';
            }
        }

        // Select garment type
        function selectGarment(garmentId) {
            selectedGarment = garmentId;
            document.querySelectorAll('.garment-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.garment-card').classList.add('selected');
            
            loadMeasurementFields();
        }

        // Load measurement fields for selected garment
        function loadMeasurementFields() {
            const measurementsContainer = document.getElementById('measurementsContainer');
            const measurementsGrid = document.getElementById('measurementsGrid');
            
            if (selectedGarment && measurementFields[selectedGarment]) {
                measurementsGrid.innerHTML = '';
                
                measurementFields[selectedGarment].forEach(field => {
                    const isAutoFilled = autoFilledData[field.id];
                    measurementsGrid.innerHTML += `
                        <div class="form-group measurement-input ${isAutoFilled ? 'autofilled' : ''}">
                            ${isAutoFilled ? '<div class="autofill-badge">AUTO</div>' : ''}
                            <label for="${field.id}">${field.label}</label>
                            <input type="number" 
                                   id="${field.id}" 
                                   placeholder="${field.placeholder}" 
                                   step="0.1"
                                   value="${isAutoFilled ? autoFilledData[field.id] : ''}">
                        </div>
                    `;
                });
                
                measurementsContainer.classList.remove('hidden');
            }
        }

        // Find BPC match and auto-fill measurements
        async function findMatch() {
            const studentData = getStudentFormData();
            
            // Validation
            if (!validateStudentData(studentData)) {
                return;
            }

            const findMatchBtn = document.getElementById('findMatchBtn');
            findMatchBtn.disabled = true;
            findMatchBtn.innerHTML = '<div class="loading"></div> Finding Match...';

            try {
                const result = await apiRequest('findBPCMatch', studentData);

                if (result.success) {
                    if (result.match) {
                        autoFilledData = result.measurements || {};
                        
                        // Show match result
                        document.getElementById('matchText').textContent = 
                            `Match found! Auto-filled based on student "${result.match.name}" (Class ${result.match.class}-${result.match.division}, Height: ${result.match.height}cm, Weight: ${result.match.weight}kg, Similarity: ${result.match.similarity}%)`;
                        document.getElementById('matchResult').classList.remove('hidden');
                        
                        // Show disclaimer
                        document.getElementById('autoFillDisclaimer').classList.remove('hidden');
                        
                        showAlert('BPC match found and measurements auto-filled successfully!', 'success');
                    } else {
                        autoFilledData = {};
                        showAlert('No suitable BPC match found. Please enter measurements manually.', 'warning');
                    }
                    
                    // Reload measurement fields with auto-filled data (if any)
                    if (selectedGarment) {
                        loadMeasurementFields();
                    }
                } else {
                    showAlert('Error: ' + result.message, 'error');
                }
                
            } catch (error) {
                showAlert('Connection error. Please check your internet connection.', 'error');
                console.error('Match finding error:', error);
            }

            findMatchBtn.disabled = false;
            findMatchBtn.innerHTML = '🔍 Find BPC Match & Auto-Fill';
        }

        // Helper function to get student form data
        function getStudentFormData() {
            return {
                studentId: document.getElementById('studentId').value.trim(),
                schoolRegNumber: document.getElementById('schoolRegNumber').value.trim(),
                studentName: document.getElementById('studentName').value.trim(),
                studentClass: document.getElementById('class').value.trim(),
                division: document.getElementById('division').value.trim(),
                dob: document.getElementById('dob').value,
                sex: document.getElementById('sex').value,
                height: parseFloat(document.getElementById('height').value),
                weight: parseFloat(document.getElementById('weight').value)
            };
        }

        // Enhanced validation function
        function validateStudentData(studentData) {
            const errors = [];

            if (!studentData.studentId) errors.push('Student ID Number is required');
            if (!studentData.schoolRegNumber) errors.push('School Register Number is required');
            if (!studentData.studentName) errors.push('Student Name is required');
            if (!studentData.studentClass) errors.push('Class is required');
            if (!studentData.division) errors.push('Division is required');
            if (!studentData.dob) errors.push('Date of Birth is required');
            if (!studentData.sex) errors.push('Gender is required');
            
            if (!studentData.height || studentData.height < 80 || studentData.height > 250) {
                errors.push('Height must be between 80-250 cm');
            }
            
            if (!studentData.weight || studentData.weight < 10 || studentData.weight > 200) {
                errors.push('Weight must be between 10-200 kg');
            }

            if (errors.length > 0) {
                showAlert(errors.join(', '), 'error');
                return false;
            }

            return true;
        }

        // Accept auto-filled measurements
        function acceptAutoFill() {
            showAlert('Auto-filled measurements accepted. You can still edit individual values if needed.', 'success');
            document.getElementById('autoFillDisclaimer').classList.add('hidden');
        }

        // Reject auto-filled measurements
        function rejectAutoFill() {
            autoFilledData = {};
            loadMeasurementFields();
            document.getElementById('autoFillDisclaimer').classList.add('hidden');
            document.getElementById('matchResult').classList.add('hidden');
            showAlert('Auto-filled measurements rejected. Please enter manually.', 'warning');
        }

        // Save measurements with validation
        async function saveMeasurements() {
            if (!selectedGarment) {
                showAlert('Please select a garment type first', 'error');
                return;
            }

            const studentData = getStudentFormData();
            
            if (!validateStudentData(studentData)) {
                return;
            }

            const measurements = {};
            let hasValues = false;

            measurementFields[selectedGarment].forEach(field => {
                const value = document.getElementById(field.id).value;
                if (value) {
                    const numValue = parseFloat(value);
                    if (numValue > 0) {
                        measurements[field.id] = numValue;
                        hasValues = true;
                    }
                }
            });

            if (!hasValues) {
                showAlert('Please enter at least one valid measurement', 'error');
                return;
            }

            try {
                const result = await apiRequest('saveMeasurements', {
                    studentData: studentData,
                    garmentType: selectedGarment,
                    measurements: measurements,
                    isAutoFilled: Object.keys(autoFilledData).length > 0
                });

                if (result.success) {
                    showAlert('✅ Student profile and measurements saved successfully!', 'success');
                    
                    // Show option to add another student
                    setTimeout(() => {
                        if (confirm('Data saved successfully! Would you like to add another student?')) {
                            newStudent();
                        }
                    }, 1500);
                } else {
                    showAlert('Error: ' + result.message, 'error');
                }
                
            } catch (error) {
                showAlert('Connection error. Please check your internet connection.', 'error');
                console.error('Save error:', error);
            }
        }

        // Clear all measurements
        function clearMeasurements() {
            if (selectedGarment && measurementFields[selectedGarment]) {
                measurementFields[selectedGarment].forEach(field => {
                    const input = document.getElementById(field.id);
                    if (input) input.value = '';
                });
                
                // Clear auto-filled data
                autoFilledData = {};
                
                // Hide disclaimer and match result
                document.getElementById('autoFillDisclaimer').classList.add('hidden');
                document.getElementById('matchResult').classList.add('hidden');
                
                // Reload fields without auto-fill styling
                loadMeasurementFields();
                
                showAlert('All measurements cleared', 'warning');
            }
        }

        // Start new student entry
        function newStudent() {
            // Clear all form fields
            document.getElementById('studentId').value = '';
            document.getElementById('schoolRegNumber').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('class').value = '';
            document.getElementById('division').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('sex').value = '';
            document.getElementById('height').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('age').value = '';
            document.getElementById('bmi').value = '';
            
            // Clear garment selection
            selectedGarment = '';
            document.querySelectorAll('.garment-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Clear measurements
            clearMeasurements();
            
            // Hide measurement container
            document.getElementById('measurementsContainer').classList.add('hidden');
            
            // Reset garment selector
            updateGarmentOptions();
            
            // Focus on first field
            document.getElementById('studentId').focus();
            
            showAlert('Ready for new student entry', 'success');
        }

        // Enhanced search for existing student
        async function searchStudent() {
            const searchTerm = prompt('Enter Student ID, School Register Number, or Name to search:');
            if (!searchTerm || searchTerm.trim() === '') {
                return;
            }

            try {
                const result = await apiRequest('searchStudents', {
                    searchTerm: searchTerm.trim()
                });

                if (result.success) {
                    if (result.students.length === 0) {
                        showAlert('No students found matching your search', 'warning');
                        return;
                    }

                    // Show search results
                    displaySearchResults(result.students);
                } else {
                    showAlert('Search error: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('Connection error during search', 'error');
                console.error('Search error:', error);
            }
        }

        // Display search results in a modal-like overlay
        function displaySearchResults(students) {
            const overlay = document.createElement('div');
            overlay.className = 'search-overlay';
            overlay.innerHTML = `
                <div class="search-modal">
                    <div class="search-header">
                        <h3>Search Results (${students.length} found)</h3>
                        <button onclick="closeSearchResults()" class="close-btn">×</button>
                    </div>
                    <div class="search-results">
                        ${students.map(student => `
                            <div class="search-result-item" onclick="loadStudent('${student.student_id_number}')">
                                <div class="student-info">
                                    <strong>${student.student_name}</strong>
                                    <div class="student-details">
                                        ID: ${student.student_id_number} | Reg: ${student.school_register_number}
                                        | Class: ${student.class}-${student.division} | ${student.sex === 'M' ? 'Male' : 'Female'}
                                        | Height: ${student.height_cm}cm | Weight: ${student.weight_kg}kg
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add styles for search modal
            const style = document.createElement('style');
            style.textContent = `
                .search-overlay {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 1000;
                    display: flex; justify-content: center; align-items: center;
                }
                .search-modal {
                    background: var(--white-bg); border-radius: 15px; max-width: 800px; width: 90%;
                    max-height: 80%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                }
                .search-header {
                    padding: 20px; border-bottom: 1px solid var(--border-color);
                    display: flex; justify-content: space-between; align-items: center;
                }
                .close-btn {
                    background: none; border: none; font-size: 1.5rem;
                    cursor: pointer; color: var(--text-secondary);
                }
                .search-results { max-height: 400px; overflow-y: auto; }
                .search-result-item {
                    padding: 15px 20px; border-bottom: 1px solid var(--border-color);
                    cursor: pointer; transition: background 0.2s;
                }
                .search-result-item:hover {
                    background: var(--light-bg);
                }
                .student-details {
                    font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(overlay);
        }

        // Load selected student data
        async function loadStudent(studentId) {
            closeSearchResults();
            
            try {
                const result = await apiRequest('getStudent', { studentId: studentId });

                if (result.success) {
                    const student = result.student;
                    
                    // Fill form with student data
                    document.getElementById('studentId').value = student.student_id_number;
                    document.getElementById('schoolRegNumber').value = student.school_register_number;
                    document.getElementById('studentName').value = student.student_name;
                    document.getElementById('class').value = student.class;
                    document.getElementById('division').value = student.division;
                    document.getElementById('dob').value = student.dob;
                    document.getElementById('sex').value = student.sex;
                    document.getElementById('height').value = student.height_cm;
                    document.getElementById('weight').value = student.weight_kg;
                    document.getElementById('age').value = student.age;
                    document.getElementById('bmi').value = student.bmi;

                    // Update garment options
                    updateGarmentOptions();

                    showAlert(`Student "${student.student_name}" loaded successfully`, 'success');
                } else {
                    showAlert('Error loading student: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('Connection error while loading student', 'error');
                console.error('Load student error:', error);
            }
        }

        // Close search results
        function closeSearchResults() {
            const overlay = document.querySelector('.search-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
    </script>
</body>
</html>